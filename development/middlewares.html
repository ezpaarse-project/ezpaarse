<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Middlewares | ezPAARSE</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Usage analyzer for your e-resources">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.e272f3b1.css" as="style"><link rel="preload" href="/assets/js/app.4f74dc86.js" as="script"><link rel="preload" href="/assets/js/3.2af4fe86.js" as="script"><link rel="preload" href="/assets/js/19.e938e799.js" as="script"><link rel="prefetch" href="/assets/js/1.8df97b16.js"><link rel="prefetch" href="/assets/js/10.47053ead.js"><link rel="prefetch" href="/assets/js/11.9fa2e821.js"><link rel="prefetch" href="/assets/js/12.38e6c878.js"><link rel="prefetch" href="/assets/js/13.ff8435dd.js"><link rel="prefetch" href="/assets/js/14.3d15d745.js"><link rel="prefetch" href="/assets/js/15.a5c4908d.js"><link rel="prefetch" href="/assets/js/16.b66e5a2f.js"><link rel="prefetch" href="/assets/js/17.d3ad558f.js"><link rel="prefetch" href="/assets/js/18.47312ace.js"><link rel="prefetch" href="/assets/js/20.7a7c241c.js"><link rel="prefetch" href="/assets/js/21.1aeb673c.js"><link rel="prefetch" href="/assets/js/22.18df69d4.js"><link rel="prefetch" href="/assets/js/23.8ca48d29.js"><link rel="prefetch" href="/assets/js/24.02c0e0da.js"><link rel="prefetch" href="/assets/js/25.522262ff.js"><link rel="prefetch" href="/assets/js/26.817d46d5.js"><link rel="prefetch" href="/assets/js/27.e0e65a35.js"><link rel="prefetch" href="/assets/js/28.f0c166f3.js"><link rel="prefetch" href="/assets/js/29.cddf8994.js"><link rel="prefetch" href="/assets/js/30.d3115b6c.js"><link rel="prefetch" href="/assets/js/31.c62d507b.js"><link rel="prefetch" href="/assets/js/32.e37eec22.js"><link rel="prefetch" href="/assets/js/33.81bcdaaa.js"><link rel="prefetch" href="/assets/js/34.d6309ccd.js"><link rel="prefetch" href="/assets/js/35.2919ef1c.js"><link rel="prefetch" href="/assets/js/36.9919178a.js"><link rel="prefetch" href="/assets/js/37.46eb2177.js"><link rel="prefetch" href="/assets/js/38.ab9808ca.js"><link rel="prefetch" href="/assets/js/39.1ae48eae.js"><link rel="prefetch" href="/assets/js/4.eada2997.js"><link rel="prefetch" href="/assets/js/40.7e41b882.js"><link rel="prefetch" href="/assets/js/41.b100be6d.js"><link rel="prefetch" href="/assets/js/42.cf529777.js"><link rel="prefetch" href="/assets/js/43.e1130ff3.js"><link rel="prefetch" href="/assets/js/44.c817b0a2.js"><link rel="prefetch" href="/assets/js/45.a1b4a0ea.js"><link rel="prefetch" href="/assets/js/46.1ad0c4e1.js"><link rel="prefetch" href="/assets/js/47.3a344627.js"><link rel="prefetch" href="/assets/js/48.c173cca3.js"><link rel="prefetch" href="/assets/js/49.0c99b622.js"><link rel="prefetch" href="/assets/js/5.8191bf0b.js"><link rel="prefetch" href="/assets/js/50.1669ba22.js"><link rel="prefetch" href="/assets/js/51.e6bdd15e.js"><link rel="prefetch" href="/assets/js/52.e04cc27e.js"><link rel="prefetch" href="/assets/js/53.88413731.js"><link rel="prefetch" href="/assets/js/54.6b985432.js"><link rel="prefetch" href="/assets/js/55.c6892faa.js"><link rel="prefetch" href="/assets/js/56.5aa5ab92.js"><link rel="prefetch" href="/assets/js/57.08e786e6.js"><link rel="prefetch" href="/assets/js/58.df964b87.js"><link rel="prefetch" href="/assets/js/59.87bd1849.js"><link rel="prefetch" href="/assets/js/6.d8a3a3dd.js"><link rel="prefetch" href="/assets/js/60.f31e19ef.js"><link rel="prefetch" href="/assets/js/61.aabe552a.js"><link rel="prefetch" href="/assets/js/62.51438e3a.js"><link rel="prefetch" href="/assets/js/63.20fad13c.js"><link rel="prefetch" href="/assets/js/64.2e7c5182.js"><link rel="prefetch" href="/assets/js/65.fe254092.js"><link rel="prefetch" href="/assets/js/66.4a5f919f.js"><link rel="prefetch" href="/assets/js/67.b7a2e582.js"><link rel="prefetch" href="/assets/js/68.c27122a6.js"><link rel="prefetch" href="/assets/js/69.a84d0f2d.js"><link rel="prefetch" href="/assets/js/7.4ff3b153.js"><link rel="prefetch" href="/assets/js/70.648b1956.js"><link rel="prefetch" href="/assets/js/71.c6464e22.js"><link rel="prefetch" href="/assets/js/72.80adbfdd.js"><link rel="prefetch" href="/assets/js/73.38b60093.js"><link rel="prefetch" href="/assets/js/8.f9e3faf4.js"><link rel="prefetch" href="/assets/js/9.7b0be85a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e272f3b1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">ezPAARSE</span></a> <div class="links"><div class="search-box"><input type="text" aria-label="Search" autocomplete="off" spellcheck="false" placeholder="Search"> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://www.ezpaarse.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Homepage
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/ezpaarse-project/ezpaarse/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Release Notes
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/ezpaarse-project/ezpaarse" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://www.ezpaarse.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Homepage
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/ezpaarse-project/ezpaarse/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Release Notes
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/ezpaarse-project/ezpaarse" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Home</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Getting started</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/start/requirements.html" class="sidebar-link">Requirements</a></li><li><a href="/start/install.html" class="sidebar-link">Installation</a></li><li><a href="/start/usage.html" class="sidebar-link">How to use</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Essential things to know</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/essential/ec-attributes.html" class="sidebar-link">Consultation/Access Events</a></li><li><a href="/essential/formats.html" class="sidebar-link">Set your log format</a></li><li><a href="/essential/knowledge-base.html" class="sidebar-link">Knowledge bases</a></li><li><a href="/essential/report.html" class="sidebar-link">Job reports</a></li><li><a href="/essential/updates.html" class="sidebar-link">Updates</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Features</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/features/outputfields.html" class="sidebar-link">Output Fields</a></li><li><a href="/features/metadata-enrichment.html" class="sidebar-link">Metadata enrichment</a></li><li><a href="/features/exclusions.html" class="sidebar-link">Bot Filtering &amp; Unrelevant Domains</a></li><li><a href="/features/counter.html" class="sidebar-link">COUNTER Reports</a></li><li><a href="/features/alerts.html" class="sidebar-link">Alerts</a></li><li><a href="/features/geolocalisation.html" class="sidebar-link">Geolocation</a></li><li><a href="/features/doubleclick.html" class="sidebar-link">Double-click deduplication</a></li><li><a href="/features/qualification.html" class="sidebar-link">Access Events Qualification</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Configuration</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/configuration/config.html" class="sidebar-link">Configuration options</a></li><li><a href="/configuration/parametres.html" class="sidebar-link">Parameters</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Developer documentation</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/development/routes.html" class="sidebar-link">Process API</a></li><li><a href="/development/admin.html" class="sidebar-link">Administration API</a></li><li><a href="/development/makefile.html" class="sidebar-link">Makefile</a></li><li><a href="/development/core.html" class="sidebar-link">Application core</a></li><li><a href="/development/platforms.html" class="sidebar-link">Platforms</a></li><li><a href="/development/middlewares.html" aria-current="page" class="active sidebar-link">Middlewares</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/development/middlewares.html#what-is-a-middleware" class="sidebar-link">What is a middleware ?</a></li><li class="sidebar-sub-header"><a href="/development/middlewares.html#how-to-load-a-middleware" class="sidebar-link">How to load a middleware ?</a></li><li class="sidebar-sub-header"><a href="/development/middlewares.html#middlewares-loaded-by-default" class="sidebar-link">Middlewares loaded by default</a></li><li class="sidebar-sub-header"><a href="/development/middlewares.html#how-to-create-a-middleware" class="sidebar-link">How to create a middleware ?</a></li></ul></li><li><a href="/development/tools.html" class="sidebar-link">Ecosystem</a></li><li><a href="/development/doc.html" class="sidebar-link">Documentation</a></li><li><a href="/development/tree.html" class="sidebar-link">Tree structure</a></li><li><a href="/development/multilinguisme.html" class="sidebar-link">Website languages</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Troubleshooting</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/troubleshooting/core-dumped.html" class="sidebar-link">Core dumped</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Middlewares</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/middlewares/anonymizer/README.html" class="sidebar-link">anonymizer</a></li><li><a href="/middlewares/bot-ua-detector/README.html" class="sidebar-link">bot-ua-detector</a></li><li><a href="/middlewares/crossref/README.html" class="sidebar-link">crossref</a></li><li><a href="/middlewares/cut/README.html" class="sidebar-link">cut</a></li><li><a href="/middlewares/deduplicator/README.html" class="sidebar-link">deduplicator</a></li><li><a href="/middlewares/ebscohost/README.html" class="sidebar-link">ebscohost</a></li><li><a href="/middlewares/enhancer/README.html" class="sidebar-link">enhancer</a></li><li><a href="/middlewares/eprints/README.html" class="sidebar-link">eprints</a></li><li><a href="/middlewares/ezunpaywall/README.html" class="sidebar-link">ezunpaywall</a></li><li><a href="/middlewares/field-splitter/README.html" class="sidebar-link">[DEPRECATED] field-splitter</a></li><li><a href="/middlewares/filter/README.html" class="sidebar-link">filter</a></li><li><a href="/middlewares/geolocalizer/README.html" class="sidebar-link">geocalizer</a></li><li><a href="/middlewares/hal/README.html" class="sidebar-link">hal</a></li><li><a href="/middlewares/host-chain/README.html" class="sidebar-link">host-chain</a></li><li><a href="/middlewares/istex/README.html" class="sidebar-link">istex</a></li><li><a href="/middlewares/labelize/README.html" class="sidebar-link">labelize</a></li><li><a href="/middlewares/on-campus-counter/README.html" class="sidebar-link">on-campus-counter</a></li><li><a href="/middlewares/panist/README.html" class="sidebar-link">panist</a></li><li><a href="/middlewares/parser/README.html" class="sidebar-link">parser</a></li><li><a href="/middlewares/populate/README.html" class="sidebar-link">populate</a></li><li><a href="/middlewares/qualifier/README.html" class="sidebar-link">qualifier</a></li><li><a href="/middlewares/robots/README.html" class="sidebar-link">robots</a></li><li><a href="/middlewares/session-id/README.html" class="sidebar-link">session-id</a></li><li><a href="/middlewares/sudoc/README.html" class="sidebar-link">sudoc</a></li><li><a href="/middlewares/throttler/README.html" class="sidebar-link">throttler</a></li><li><a href="/middlewares/trackcode-generator/README.html" class="sidebar-link">trackcode-generator</a></li><li><a href="/middlewares/unpaywall/README.html" class="sidebar-link">unpaywall</a></li><li><a href="/middlewares/user-agent-parser/README.html" class="sidebar-link">user-agent-parser</a></li><li><a href="/middlewares/zotero/README.html" class="sidebar-link">zotero</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="middlewares"><a href="#middlewares" class="header-anchor">#</a> Middlewares</h1> <p>NB: The middlewares have their <a href="https://github.com/ezpaarse-project/ezpaarse-middlewares" target="_blank" rel="noopener noreferrer">own dedicated repository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="what-is-a-middleware"><a href="#what-is-a-middleware" class="header-anchor">#</a> What is a middleware ?</h2> <p>Middlewares are functions that constitute the processing chain. The middlewares are successively applied to the consultation events processed by ezPAARSE and turnthem into the definitive form they will have when the events are eventually written in the result file.</p> <h2 id="how-to-load-a-middleware"><a href="#how-to-load-a-middleware" class="header-anchor">#</a> How to load a middleware ?</h2> <p>To become part of the processing chain, a middleware must have its name (<em>ie</em> the name of its file, without the <code>.js</code> suffix) added to the <code>EZPAARSE_MIDDLEWARES</code> array in the config file. The order of declaration in the array determines the order in which middlewares are called.</p> <h2 id="middlewares-loaded-by-default"><a href="#middlewares-loaded-by-default" class="header-anchor">#</a> Middlewares loaded by default</h2> <table><thead><tr><th colspan="3">Middlewares</th></tr></thead> <tbody><tr><td><span style="font-size:12px;">1.</span> <a href="/middlewares/filter.html">filter</a></td> <td><span style="font-size:12px;">2.</span> <a href="/middlewares/parser.html">parser</a></td> <td><span style="font-size:12px;">3.</span> <a href="/middlewares/deduplicator.html">deduplicator</a></td></tr> <tr><td><span style="font-size:12px;">4.</span> <a href="/middlewares/istex.html">istex</a></td> <td><span style="font-size:12px;">5.</span> <a href="/middlewares/crossref.html">crossref</a></td> <td><span style="font-size:12px;">6.</span> <a href="/middlewares/sudoc.html">sudoc</a></td></tr> <tr><td><span style="font-size:12px;">7.</span> <a href="/middlewares/hal.html">hal</a></td> <td><span style="font-size:12px;">8.</span> <a href="/middlewares/enhancer.html">enhancer</a></td> <td><span style="font-size:12px;">9.</span> <a href="/middlewares/geolocalizer.html">geolocalizer</a></td></tr> <tr><td><span style="font-size:12px;">10.</span> <a href="/middlewares/cut.html">cut</a></td> <td><span style="font-size:12px;">11.</span> <a href="/middlewares/on-campus-counter.html">on-campus-counter</a></td> <td><span style="font-size:12px;">12.</span> <a href="/middlewares/qualifier.html">qualifier</a></td></tr> <tr><td><span style="font-size:12px;">13.</span> <a href="/middlewares/anonymizer.html">anonymizer</a></td> <td></td> <td></td></tr></tbody></table> <h2 id="how-to-create-a-middleware"><a href="#how-to-create-a-middleware" class="header-anchor">#</a> How to create a middleware ?</h2> <h3 id="specifications"><a href="#specifications" class="header-anchor">#</a> Specifications</h3> <p>Each middleware must have its own directory, with <code>index.js</code> as entrypoint, and must export a function that will serve as <code>initiator</code>. The initiator function must return either the actual processing function, or a <code>promise</code> that will then return it. In case of failure during the initialization, returning an <code>Error</code> object (or rejecting the <code>promise</code>) will abort the job. The error object should be extended with a <code>status</code> property that specify the status code to send back (defaults to <strong>500</strong>), and optionally a <code>code</code> property for the ezPAARSE-specific status (inserted in the header <strong>ezPAARSE-Status</strong>). The error message will be inserted in the header <strong>ezPAARSE-Status-Message</strong>.</p> <p>The <code>processing function</code> takes the EC as first argument and a function to call when the EC should go on to the next middleware. Calling this function with an error will result in the EC being rejected. When there's no line left to read, the function will be called with <code>null</code> as EC.</p> <p>The <code>initiator</code> and the <code>processing function</code> have the following properties in their context (this) :</p> <ul><li><code>request</code>: the request stream.</li> <li><code>response</code>: the response stream.</li> <li><code>job</code>: the job object.</li> <li><code>logger</code>: a winston instance (shorthand for job.logger).</li> <li><code>report</code>: a report object (shorthand for job.report).</li> <li><code>saturate</code>: a function to call when the middleware is saturated.</li> <li><code>drain</code>: a function to call when the middleware is not saturated anymore.</li></ul> <h3 id="example"><a href="#example" class="header-anchor">#</a> Example</h3> <h4 id="article-counter"><a href="#article-counter" class="header-anchor">#</a> Article counter</h4> <p>Here is an example of a very simple middleware that counts the articles and put the total in the report as <code>General -&gt; nb-articles</code> :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">articleCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'Initializing article counter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>report<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'general'</span><span class="token punctuation">,</span> <span class="token string">'nb-articles'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Processing function</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token parameter">ec<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ec<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ec<span class="token punctuation">.</span>rtype <span class="token operator">===</span> <span class="token string">'ARTICLE'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>report<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token string">'general'</span><span class="token punctuation">,</span> <span class="token string">'nb-articles'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="mandatory-field"><a href="#mandatory-field" class="header-anchor">#</a> Mandatory field</h4> <p>This middleware is a bit more advanced. It's activated by giving a field name in the <code>Mandatory-Field</code> header and it filters any EC that doesn't have a value for this field. An error is thrown on startup if the header contains a space.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">mandatoryField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'Initializing mandatory field'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> mandatoryField <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Mandatory-Field'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mandatoryField <span class="token operator">&amp;&amp;</span> mandatoryField<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'space not allowed in mandatory field'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Actual processing function
   * @param  {Object}   ec   the EC to process, null if no EC left
   * @param  {Function} next the function to call when we are done with the given EC
   */</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">ec<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mandatoryField <span class="token operator">||</span> <span class="token operator">!</span>ec<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ec<span class="token punctuation">[</span>mandatoryField<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>mandatoryField <span class="token operator">+</span> <span class="token string">' is missing'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="use-of-promises"><a href="#use-of-promises" class="header-anchor">#</a> Use of promises</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">mandatoryField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'initialization failed for some reason'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">ec<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Processing function</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ezpaarse-project/ezpaarse/edit/master/doc/development/middlewares.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/25/2022, 11:21:41 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/development/platforms.html" class="prev">
        Platforms
      </a></span> <span class="next"><a href="/development/tools.html">
        Ecosystem
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4f74dc86.js" defer></script><script src="/assets/js/3.2af4fe86.js" defer></script><script src="/assets/js/19.e938e799.js" defer></script>
  </body>
</html>
