# Process API

ezPAARSE is a [RESTful](https://en.wikipedia.org/wiki/Representational_state_transfer) application.
**REST**: Representational State Transfer

## Sending logs
The main route for ezPAARSE is the **root** of the web service. The **GET** method gives access to the logs submission form, and the **POST** method allows sending logs.
The submitted files are parsed and access events are sent back, as a resulting stream.

<table>
  <tr>
      <th style="text-align:left;width:140px;">PATH</th>
      <th> GET </th>
      <th> POST </th>
  </tr>
  <tr>
    <td>/</td>
    <td>Submission form</td>
    <td>Parses a log file</td>
  </tr>
</table>


### The detailed POST request

*POST / HTTP/1.1*

#### Parameters (headers)
[The parameters list](../configuration/parametres.html)

#### Body

Log lines generated by a proxy server.

[EZProxy documentation](http://www.oclc.org/support/documentation/ezproxy/cfg/logformat/)
[Squid documentation](http://www.squid-cache.org/Doc/config/logformat/)

### Response to a POST request

#### Status code

-   **200 OK:** the logs have been successfully processed.
-   **400 Bad Request:** a request element makes the processing of logs impossible.
-   **406 Not Acceptable:** encoding or output format not supported.

#### Headers
-   **Job-ID:** unique identifier associated to the current processing job.
-   **Job-Report:** URL for the detailed processing report, including all of the headers sent by ezPAARSE.
-   **ezPAARSE-Status:** return code if an error is raised.
-   **ezPAARSE-Status-Message:** explanation message on the return code.

Headers containing the URLs for accessing the logs :

-   **Job-Traces:** traces for the current ezPAARSE job (the verbosity level can be modified with the Traces-Level header)
-   **Lines-Unknown-Formats:** lines for which the format has not been recognized.
-   **Lines-Ignored-Domains:** lines for which the domain is ignored.
-   **Lines-Unknown-Domains:** lines for which the domain is not associated to a parser.
-   **Lines-Unqualified-ECs:** lines that generated access events with too few information. [(More details)](../features/qualification.html)
-   **Lines-PKB-Miss-ECs:** lines that generated identifiers that can't be found in the PKB for the corresponding platform.
-   **Lines-Duplicate-ECs:** lines filtered out by the double-clicks detection algorithm.
-   **Lines-Unordered-ECs:** lines rejected because they were not chronologically ordered
-   **Lines-Robots-ECs:** lines generated by non-human agents (robots, crawlers, spides, etc.).
-   **Lines-Ignored-Hosts:** lines that were filtered based on their IP address.
-   **Lines-Unknown-Errors:** lines that were rejected due to unknown errors.

#### Body

CSV or JSON containing all of the generated access events.

Access event example:

```json
{
  "host": "1234567d6b8dd5dddc87939c4a407987",
  "login": "IDEXEMPLE",
  "date": "2011-12-31T10:42:42+01:00",
  "url": "http://www.une-adresse.com/exemple.php?id=16",
  "status": "200",
  "size": "0",
  "domain": "www.une-adresse.com",
  "type": "PDF",
  "issn": "1111-1111"
}
```

### Request examples
```bash
curl -X POST http://127.0.0.1:59599 --no-buffer --data-binary @file.log -v
curl -X POST --proxy "" --no-buffer --data-binary @test/dataset/sd.2012-11-30.log  http://127.0.0.1:59599 -v
curl -X POST --proxy "" --no-buffer -H "Accept: application/json" --data-binary @test/dataset/sd.2012-11-30.log  http://127.0.0.1:59599 -v
```

## Access the traces and rejects

When ezPAARSE is processing a request (a job), it generates informative files bound to its activity.
Those can be accessed by using the unique identifier attributed to the job.

<table>
    <tr>
        <th style="text-align:left;width:240px;">PATH</th>
        <th>Information given</th>
    </tr>
    <tr>
      <td>/{jobID}/job-traces.log</td>
      <td>Traces of the internal process. It's only interesting when a something has gone wrong.</td>
    </tr>
    <tr>
      <td>/{jobID}/job-report.(json|html)</td>
      <td>Report aggregating data on the job: how many lines were rejected, reject rate, date and job duration, etc. Use it like /{jobID}/job-report.html?standalone=1 to generate a standalone html report</td>
    </tr>
    <tr>
      <td>/{jobID}/lines-unknown-formats.log</td>
      <td>Lines for which the format was not recognized because it doesn't look like the input parameters</td>
    </tr>
    <tr>
      <td>/{jobID}/lines-ignored-domains.log</td>
      <td>Lines for which the domain is ignored.</td>
    </tr>
    <tr>
      <td>/{jobID}/lines-unknown-domains.log</td>
      <td>Lines for which the domain is not associated to a parser.</td>
    </tr>
    <tr>
      <td>/{jobID}/lines-unqualified-ecs.log</td>
      <td>Lines that generated access events with too few information. [(More details)](../features/qualification.html)</td>
    </tr>
    <tr>
      <td>/{jobID}/lines-pkb-miss-ecs.log</td>
      <td>Lines that generated identifiers that can't be found in the PKB for the corresponding platform.</td>
    </tr>
    <tr>
      <td>/{jobID}/lines-duplicate-ecs.log</td>
      <td>Lines filtered out by the COUNTER double-clicks detection algorithm.</td>
    </tr>
    <tr>
      <td>/{jobID}/lines-unordered-ecs.log</td>
      <td>Lines rejected because they were not chronologically ordered.</td>
    </tr>
    <tr>
      <td>/{jobID}/lines-robots-ecs.log</td>
      <td>Lines generated by non-human agents (robots, crawlers, spides, etc.).</td>
    </tr>
    <tr>
      <td>/{jobID}/lines-ignored-hosts.log</td>
      <td>Lines that were filtered based on their IP address.</td>
    </tr>
    <tr>
      <td>/{jobID}/lines-unknown-errors.log</td>
      <td>Lines that were rejected due to unknown errors.</td>
    </tr>
</table>

- jobID: unique identifier attributed to the job.

## General information
These routes are useful to get various information like: the list of platforms, the types of access events. They only respond to the *GET* method.

<table>
    <tr>
        <th style="text-align:left;width:140px;">URL</th>
        <th>Information given</th>
    </tr>
    <tr>
      <td>/info/platforms</td>
      <td>Lists the available plateforms</td>
    </tr>
    <tr>
      <td>/info/rid</td>
      <td>Lists the resources identifiers</td>
    </tr>
    <tr>
      <td>/info/rtype</td>
      <td>Lists the resources types</td>
    </tr>
    <tr>
      <td>/info/mime</td>
      <td>Lists the resources formats (or mimetypes)</td>
    </tr>
    <tr>
      <td>/info/codes</td>
      <td>Lists the application's return codes and their meaning</td>
    </tr>
    <tr>
      <td>/info/codes/{code}</td>
      <td>Returns the meaning of one return code</td>
    </tr>
    <tr>
      <td>/info/form-predefined</td>
      <td>lists the predefined parameters for the advanced options in the form</td>
    </tr>
    <tr>
      <td>/info/usage</td>
      <td>General usage statistics</td>
    </tr>
</table>

## Administration
These routes are used to administrate ezPAARSE. For the most part, they can be used through the application's admin page. They require being authentified, except for /api/admin/register.

<table>
    <tr>
        <th style="text-align:left;width:140px;">PATH</th>
        <th style="text-align:left;width:80px;">MÃ©thode</th>
        <th>Usage</th>
    </tr>
    <tr>
      <td>/api/admin/register</td>
      <td>POST</td>
      <td>Creates the first account as administrator. It doesn't work if one or more users are already existing.
        <br/>Parameters: <strong>username</strong>, <strong>password</strong></td>
    </tr>
    <tr>
      <td>/api/admin/platforms/status</td>
      <td>GET</td>
      <td>Reports on the platforms' state
        <br/>Returns: <strong>uptodate</strong> or <strong>outdated</strong></td>
    </tr>
    <tr>
      <td>/api/admin/platforms/status</td>
      <td>PUT</td>
      <td>Updates the platforms
        <br/>The body must contain <strong>uptodate</strong></td>
    </tr>
    <tr>
      <td>/api/admin/users</td>
      <td>GET</td>
      <td>Returns the list of local users</td>
    </tr>
    <tr>
      <td>/api/admin/users/</td>
      <td>POST</td>
      <td>Creates a local user
        <br/>Parameters: <strong>username</strong>, <strong>password</strong></td>
    </tr>
    <tr>
      <td>/api/admin/users/{username}</td>
      <td>DELETE</td>
      <td>Deletes a local user</td>
    </tr>
</table>
