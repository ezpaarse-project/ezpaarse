<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Middlewares</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.9422d7ed.css" as="style"><link rel="preload" href="/assets/js/app.0774983a.js" as="script"><link rel="preload" href="/assets/js/2.f1c961ca.js" as="script"><link rel="preload" href="/assets/js/15.bc06572c.js" as="script"><link rel="prefetch" href="/assets/js/10.e46d72ad.js"><link rel="prefetch" href="/assets/js/11.8254d096.js"><link rel="prefetch" href="/assets/js/12.ee9e402b.js"><link rel="prefetch" href="/assets/js/13.83e5ba5e.js"><link rel="prefetch" href="/assets/js/14.b28cb6fa.js"><link rel="prefetch" href="/assets/js/16.adf7ee00.js"><link rel="prefetch" href="/assets/js/17.638c8a0e.js"><link rel="prefetch" href="/assets/js/18.661a591c.js"><link rel="prefetch" href="/assets/js/19.7fb5808b.js"><link rel="prefetch" href="/assets/js/20.ecf034ed.js"><link rel="prefetch" href="/assets/js/21.9b198a89.js"><link rel="prefetch" href="/assets/js/22.6a51d93b.js"><link rel="prefetch" href="/assets/js/23.0a1cfe35.js"><link rel="prefetch" href="/assets/js/24.b90ca5c4.js"><link rel="prefetch" href="/assets/js/25.33941b02.js"><link rel="prefetch" href="/assets/js/26.95b36b7b.js"><link rel="prefetch" href="/assets/js/27.3535f59c.js"><link rel="prefetch" href="/assets/js/28.64562af7.js"><link rel="prefetch" href="/assets/js/29.849624e7.js"><link rel="prefetch" href="/assets/js/3.7ef52252.js"><link rel="prefetch" href="/assets/js/30.cbe296a5.js"><link rel="prefetch" href="/assets/js/31.6cbf0b0f.js"><link rel="prefetch" href="/assets/js/32.5b861b2b.js"><link rel="prefetch" href="/assets/js/33.acf6a958.js"><link rel="prefetch" href="/assets/js/34.a957457a.js"><link rel="prefetch" href="/assets/js/35.1035d599.js"><link rel="prefetch" href="/assets/js/36.fcc7fbc8.js"><link rel="prefetch" href="/assets/js/37.bbcb34fe.js"><link rel="prefetch" href="/assets/js/38.326e2ab1.js"><link rel="prefetch" href="/assets/js/39.4db4134f.js"><link rel="prefetch" href="/assets/js/4.4c2548f6.js"><link rel="prefetch" href="/assets/js/40.b6150ce1.js"><link rel="prefetch" href="/assets/js/5.8a2b5103.js"><link rel="prefetch" href="/assets/js/6.3a5b4460.js"><link rel="prefetch" href="/assets/js/7.60024c79.js"><link rel="prefetch" href="/assets/js/8.bcfb9593.js"><link rel="prefetch" href="/assets/js/9.e0370369.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9422d7ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="middlewares"><a href="#middlewares" class="header-anchor">#</a> Middlewares</h1> <p>NB: The middlewares have their <a href="https://github.com/ezpaarse-project/ezpaarse-middlewares" target="_blank" rel="noopener noreferrer">own dedicated repository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="what-is-a-middleware"><a href="#what-is-a-middleware" class="header-anchor">#</a> What is a middleware ?</h2> <p>Middlewares are functions that constitute the processing chain. The middlewares are successively applied to the consultation events processed by ezPAARSE and turnthem into the definitive form they will have when the events are eventually written in the result file.</p> <h2 id="how-to-load-a-middleware"><a href="#how-to-load-a-middleware" class="header-anchor">#</a> How to load a middleware ?</h2> <p>To become part of the processing chain, a middleware must have its name (<em>ie</em> the name of its file, without the <code>.js</code> suffix) added to the <code>EZPAARSE_MIDDLEWARES</code> array in the config file. The order of declaration in the array determines the order in which middlewares are called.</p> <h2 id="middlewares-loaded-by-default"><a href="#middlewares-loaded-by-default" class="header-anchor">#</a> Middlewares loaded by default</h2> <table><thead><tr><th colspan="3">Middlewares</th></tr></thead> <tbody><tr><td><span style="font-size:12px;">1.</span> <a href="/middlewares/filter.html">filter</a></td> <td><span style="font-size:12px;">2.</span> <a href="/middlewares/parser.html">parser</a></td> <td><span style="font-size:12px;">3.</span> <a href="/middlewares/deduplicator.html">deduplicator</a></td></tr> <tr><td><span style="font-size:12px;">4.</span> <a href="/middlewares/istex.html">istex</a></td> <td><span style="font-size:12px;">5.</span> <a href="/middlewares/crossref.html">crossref</a></td> <td><span style="font-size:12px;">6.</span> <a href="/middlewares/sudoc.html">sudoc</a></td></tr> <tr><td><span style="font-size:12px;">7.</span> <a href="/middlewares/hal.html">hal</a></td> <td><span style="font-size:12px;">8.</span> <a href="/middlewares/enhancer.html">enhancer</a></td> <td><span style="font-size:12px;">9.</span> <a href="/middlewares/geolocalizer.html">geolocalizer</a></td></tr> <tr><td><span style="font-size:12px;">10.</span> <a href="/middlewares/cut.html">cut</a></td> <td><span style="font-size:12px;">11.</span> <a href="/middlewares/on-campus-counter.html">on-campus-counter</a></td> <td><span style="font-size:12px;">12.</span> <a href="/middlewares/qualifier.html">qualifier</a></td></tr> <tr><td><span style="font-size:12px;">13.</span> <a href="/middlewares/anonymizer.html">anonymizer</a></td> <td></td> <td></td></tr></tbody></table> <h2 id="how-to-create-a-middleware"><a href="#how-to-create-a-middleware" class="header-anchor">#</a> How to create a middleware ?</h2> <h3 id="specifications"><a href="#specifications" class="header-anchor">#</a> Specifications</h3> <p>Each middleware must have its own directory, with <code>index.js</code> as entrypoint, and must export a function that will serve as <code>initiator</code>. The initiator function must return either the actual processing function, or a <code>promise</code> that will then return it. In case of failure during the initialization, returning an <code>Error</code> object (or rejecting the <code>promise</code>) will abort the job. The error object should be extended with a <code>status</code> property that specify the status code to send back (defaults to <strong>500</strong>), and optionally a <code>code</code> property for the ezPAARSE-specific status (inserted in the header <strong>ezPAARSE-Status</strong>). The error message will be inserted in the header <strong>ezPAARSE-Status-Message</strong>.</p> <p>The <code>processing function</code> takes the EC as first argument and a function to call when the EC should go on to the next middleware. Calling this function with an error will result in the EC being rejected. When there's no line left to read, the function will be called with <code>null</code> as EC.</p> <p>The <code>initiator</code> and the <code>processing function</code> have the following properties in their context (this) :</p> <ul><li><code>request</code>: the request stream.</li> <li><code>response</code>: the response stream.</li> <li><code>job</code>: the job object.</li> <li><code>logger</code>: a winston instance (shorthand for job.logger).</li> <li><code>report</code>: a report object (shorthand for job.report).</li> <li><code>saturate</code>: a function to call when the middleware is saturated.</li> <li><code>drain</code>: a function to call when the middleware is not saturated anymore.</li></ul> <h3 id="example"><a href="#example" class="header-anchor">#</a> Example</h3> <h4 id="article-counter"><a href="#article-counter" class="header-anchor">#</a> Article counter</h4> <p>Here is an example of a very simple middleware that counts the articles and put the total in the report as <code>General -&gt; nb-articles</code> :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">articleCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'Initializing article counter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>report<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'general'</span><span class="token punctuation">,</span> <span class="token string">'nb-articles'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Processing function</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token parameter">ec<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ec<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ec<span class="token punctuation">.</span>rtype <span class="token operator">===</span> <span class="token string">'ARTICLE'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>report<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token string">'general'</span><span class="token punctuation">,</span> <span class="token string">'nb-articles'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="mandatory-field"><a href="#mandatory-field" class="header-anchor">#</a> Mandatory field</h4> <p>This middleware is a bit more advanced. It's activated by giving a field name in the <code>Mandatory-Field</code> header and it filters any EC that doesn't have a value for this field. An error is thrown on startup if the header contains a space.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">mandatoryField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'Initializing mandatory field'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> mandatoryField <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Mandatory-Field'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mandatoryField <span class="token operator">&amp;&amp;</span> mandatoryField<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'space not allowed in mandatory field'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Actual processing function
   * @param  {Object}   ec   the EC to process, null if no EC left
   * @param  {Function} next the function to call when we are done with the given EC
   */</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">ec<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mandatoryField <span class="token operator">||</span> <span class="token operator">!</span>ec<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ec<span class="token punctuation">[</span>mandatoryField<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>mandatoryField <span class="token operator">+</span> <span class="token string">' is missing'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="use-of-promises"><a href="#use-of-promises" class="header-anchor">#</a> Use of promises</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">mandatoryField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'initialization failed for some reason'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">ec<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Processing function</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0774983a.js" defer></script><script src="/assets/js/2.f1c961ca.js" defer></script><script src="/assets/js/15.bc06572c.js" defer></script>
  </body>
</html>
